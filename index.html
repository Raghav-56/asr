<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ASR Test UI</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; line-height: 1.4; }
      header { margin-bottom: 1rem; }
      fieldset { border: 1px solid #8884; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
      legend { padding: 0 .5rem; font-weight: 600; }
      label { display: block; margin: .5rem 0 .25rem; font-size: .9rem; }
      input[type="text"], input[type="url"], input[type="password"], select { width: 100%; padding: .5rem .6rem; border-radius: 6px; border: 1px solid #8884; background: inherit; }
      input[type="file"] { margin-top: .25rem; }
      button { appearance: none; border: 1px solid #5556; padding: .6rem 1rem; border-radius: 8px; cursor: pointer; background: #2d6cdf; color: #fff; font-weight: 600; }
      button[disabled] { opacity: .6; cursor: not-allowed; }
      .row { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 1rem; }
      .muted { color: #888; font-size: .85rem; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
      .log { white-space: pre-wrap; background: #00000008; border: 1px solid #8884; padding: .75rem; border-radius: 8px; min-height: 3rem; }
      .col { display: flex; flex-direction: column; gap: .5rem; }
    </style>
    <!-- Appwrite Web SDK from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@latest"></script>
  </head>
  <body>
    <header>
      <h1>Speech Transcription Test</h1>
      <p class="muted">Basic UI to upload an audio file to Appwrite Storage and call your function to transcribe it.</p>
    </header>

    <form id="asrForm">
      <fieldset>
        <legend>File</legend>
        <label for="audio">Audio file (wav/mp3/m4a/ogg)</label>
        <input id="audio" name="audio" type="file" accept="audio/*" required />
      </fieldset>

      <fieldset>
        <legend>Appwrite Storage</legend>
        <div class="row">
          <div class="col">
            <label for="endpoint">Endpoint</label>
            <input id="endpoint" name="endpoint" type="url" placeholder="https://cloud.appwrite.io/v1" />
          </div>
          <div class="col">
            <label for="projectId">Project ID</label>
            <input id="projectId" name="projectId" type="text" placeholder="YOUR_PROJECT_ID" />
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label for="bucketId">Bucket ID</label>
            <input id="bucketId" name="bucketId" type="text" placeholder="speech_recognition" value="speech_recognition" />
          </div>
          <div class="col">
            <label for="appwriteApiKey">Appwrite API Key (for upload)</label>
            <input id="appwriteApiKey" name="appwriteApiKey" type="password" placeholder="APPWRITE_API_KEY (scoped)" />
          </div>
        </div>
        <p class="muted">Note: Using an API key in the browser is not recommended for production. Use a scoped key with minimal storage permissions for testing and ensure CORS allows this origin.</p>
      </fieldset>

      <fieldset>
        <legend>Transcription Function</legend>
        <div class="row">
          <div class="col">
            <label for="functionUrl">Function URL</label>
            <input id="functionUrl" name="functionUrl" type="url" placeholder="https://your-function-endpoint" required />
          </div>
          <div class="col">
            <label for="functionKey">x-appwrite-key (for function)</label>
            <input id="functionKey" name="functionKey" type="password" placeholder="APPWRITE_API_KEY used by function" />
          </div>
        </div>
        <p class="muted">The function receives the fileId and uses this key in the <span class="mono">x-appwrite-key</span> header to download the file and store the result.</p>
      </fieldset>

      <div style="display:flex; gap:.75rem; align-items:center;">
        <button id="runBtn" type="submit">Upload & Transcribe</button>
        <span id="status" class="muted"></span>
      </div>
    </form>

    <h3>Result</h3>
    <div class="log" id="output"></div>

    <script>
      const $ = (id) => document.getElementById(id);

      function log(msg) {
        const out = $("output");
        out.textContent = (out.textContent ? out.textContent + "\n" : "") + msg;
      }

      function setStatus(msg) {
        $("status").textContent = msg || "";
      }

      // Try to load local ui-config.json to prefill fields for convenience (not required)
      fetch('./ui-config.json', { cache: 'no-store' }).then(async (r) => {
        if (!r.ok) return;
        try {
          const cfg = await r.json();
          if (cfg.endpoint) $("endpoint").value = cfg.endpoint;
          if (cfg.projectId) $("projectId").value = cfg.projectId;
          if (cfg.bucketId) $("bucketId").value = cfg.bucketId;
          if (cfg.appwriteApiKey) $("appwriteApiKey").value = cfg.appwriteApiKey;
          if (cfg.functionUrl) $("functionUrl").value = cfg.functionUrl;
          if (cfg.functionKey) $("functionKey").value = cfg.functionKey;
        } catch {}
      }).catch(() => {});

      async function uploadToAppwrite({ endpoint, projectId, apiKey, bucketId, file }) {
        if (!endpoint || !projectId) throw new Error("Missing Appwrite endpoint or projectId");
        if (!file) throw new Error("No file selected");

        const client = new Appwrite.Client();
        client.setEndpoint(endpoint).setProject(projectId);
        // Browser SDKs do not support API keys. Use a session instead (anonymous for testing).
        // If setKey exists (e.g., node/server builds), guard its usage to avoid runtime errors in the browser.
        if (apiKey && typeof client.setKey === "function") {
          client.setKey(apiKey);
        } else {
          const account = new Appwrite.Account(client);
          try {
            // If there's no active session, create an anonymous one for testing.
            await account.get();
          } catch (_) {
            try { await account.createAnonymousSession(); } catch (e) {
              console.warn("Anonymous session failed:", e);
            }
          }
        }

        const storage = new Appwrite.Storage(client);
        const fileId = Appwrite.ID.unique();
        const created = await storage.createFile(bucketId || "speech_recognition", fileId, file);
        return created.$id;
      }

      async function callTranscription({ functionUrl, functionKey, fileId, bucketId }) {
        if (!functionUrl) throw new Error("Missing function URL");
        const headers = { "Content-Type": "application/json" };
        if (functionKey) headers["x-appwrite-key"] = functionKey;

        const res = await fetch(functionUrl, {
          method: "POST",
          headers,
          body: JSON.stringify({ fileId, bucketId }),
        });

        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch (_) { data = { raw: text }; }

        if (!res.ok) {
          throw new Error(data && (data.error || data.message) || `HTTP ${res.status}`);
        }
        return data;
      }

      $("asrForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        $("output").textContent = "";
        setStatus("");

        const fileInput = $("audio");
        const file = fileInput.files && fileInput.files[0];
        if (!file) {
          alert("Please choose an audio file.");
          return;
        }

        const endpoint = $("endpoint").value.trim();
        const projectId = $("projectId").value.trim();
        const bucketId = $("bucketId").value.trim() || "speech_recognition";
        const appwriteApiKey = $("appwriteApiKey").value.trim();

        const functionUrl = $("functionUrl").value.trim();
        const functionKey = $("functionKey").value.trim();

        const btn = $("runBtn");
        btn.disabled = true;
        try {
          setStatus("Uploading to Appwrite...");
          const fileId = await uploadToAppwrite({ endpoint, projectId, apiKey: appwriteApiKey, bucketId, file });
          log(`Uploaded fileId: ${fileId}`);

          setStatus("Transcribing...");
          const result = await callTranscription({ functionUrl, functionKey, fileId, bucketId });
          log("Transcription complete.");
          log("");
          log("Response:");
          log(JSON.stringify(result, null, 2));
          setStatus("Done");
        } catch (err) {
          console.error(err);
          log(`Error: ${err.message || err}`);
          setStatus("Failed");
        } finally {
          btn.disabled = false;
        }
      });
    </script>
  </body>
  </html>
